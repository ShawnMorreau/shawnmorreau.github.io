/* globals __DEV__ */

import { events, frame, play as corePlay, timeline as coreTimeline } from 'wilderness-core';
import { updateNode } from 'wilderness-dom-node';

/**
 * Is the tick function running?
 */
var ticks = 0;

/**
 * Extends the Wilderness core play function.
 * Adds a call to the tick function.
 *
 * @param {Timeline} t
 * @param {PlaybackOptions} playbackOptions
 * @param {number} [at]
 */
var play = function play(t, playbackOptions, at) {
  corePlay(t, playbackOptions, at);
  tick();
};

/**
 * Calculate the active Timeline Shapes and update the corresponding Nodes.
 * Call recursively until there are no longer any active Timelines.
 *
 * @param {number} [at]
 *
 * @example
 * tick()
 */
var tick = function tick(at) {
  if (!ticks) {
    if (process.env.NODE_ENV !== 'production' && typeof at !== 'undefined' && typeof at !== 'number') {
      throw new TypeError('The tick functions at option must be of type number');
    }

    window.requestAnimationFrame(function () {
      var a = typeof at !== 'undefined' ? at : Date.now();

      var retick = false;

      ticks++;

      for (var i = 0, l = timelines.length; i < l; i++) {
        var t = timelines[i];
        var state = t.state;

        if (state.started && !state.finished && state.rendered) {
          var timelineShapes = t.timelineShapes;
          var frameShapes = frame(t, a);

          for (var _i = 0, _l = timelineShapes.length; _i < _l; _i++) {
            updateNode(timelineShapes[_i].shape.node, frameShapes[_i]);
          }

          events(t);

          retick = true;
        }
      }

      ticks--;

      if (retick) {
        tick();
      }
    });
  }
};

/**
 * Extends the Wilderness core timeline function.
 * Pushes each timeline into the timelines array.
 *
 * @param {...(Shape|Object[]|TimelineOptions)[]} props
 *
 * @returns {Timeline}
 *
 * @example
 * timeline(circle, [ square, { queue: -200 } ], { duration: 5000 })
 */
var timeline = function timeline() {
  var t = coreTimeline.apply(undefined, arguments);
  timelines.push(t);
  return t;
};

/**
 * An array of every Timeline created.
 */
var timelines = [];

export { play, tick };
export default timeline;